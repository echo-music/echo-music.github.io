---
layout: post
title: holmes服务性能指标监控，让bug无处遁行！
categories: go
description: holmes服务性能指标监控，让bug无处遁行！
keywords: holmes,pprof
---

作为一名"懒惰"的程序员，如何避免在线上Golang系统半夜宕机 （一般是OOM导致的）时起床保存现场呢？又或者如何dump压测时性能尖刺时刻的profile文件呢？
holmes 或许能帮助您解决以上问题。

# holmes性能指标监控

## holmes是什么？

```
对于系统的性能尖刺问题，我们通常使用 Go 官方内置的 pprof 包进行分析，但是难点是对于一闪而过的“尖刺”，

开发人员很难及时保存现场：当你收到告警信息，从被窝中爬起来，打开电脑链接 VPN，系统说不定都已经重启三四趟了。

MOSN 社区的 Holmes 是一个基于 Golang 实现的轻量级性能监控系统，当应用的性能指标发生了异常波动时，

Holmes 会在第一时间保留现场，让你第二天上班可以一边做着大保健，一边追查问题的根因。

```

## 快速入门
### 一、监控内存
```
package main

import (
	"fmt"
	"mosn.io/holmes"
	"mosn.io/pkg/log"
	"net/http"
	"time"
)

func init() {
	http.HandleFunc("/make1gb", make1gbslice)
	go http.ListenAndServe(":10003", nil)
}

var grReportCount int
var cpuReportCount int
var memReportCount int

type ReporterImpl struct{}

func (r *ReporterImpl) Report(pType string, buf []byte, reason string, eventID string) error {
	fmt.Println(fmt.Sprintf("call %s report \n", pType))

	switch pType {
	case "goroutine":
		grReportCount++
	case "cpu":
		cpuReportCount++
	case "mem":
		memReportCount++

	}
	fmt.Println("type=", pType, "reason=", reason, "eventid=", eventID)
	fmt.Println("content =", string(buf))
	return nil

}
func main() {
	r := &ReporterImpl{} // a implement of holmes.ProfileReporter Interface.

	h, _ := holmes.New(
		holmes.WithProfileReporter(r),
		holmes.WithCollectInterval("2s"),
		holmes.WithDumpPath("/tmp/holmes"),
		//holmes.WithTextDump(),
		holmes.WithMemDump(3, 25, 80, time.Minute),
		holmes.WithCPUDump(1, 25, 80, time.Minute),
		holmes.WithGCHeapDump(10, 20, 40, time.Minute),
		holmes.WithGoroutineDump(5, 25, 20000, 0, time.Minute),
		holmes.WithLogger(holmes.NewFileLog("/tmp/holmes/holmes.log", log.ERROR)),
	)

	h.EnableCPUDump().
		EnableGoroutineDump().
		EnableMemDump().
		EnableGCHeapDump().Start()
	time.Sleep(time.Hour)

}

func make1gbslice(wr http.ResponseWriter, req *http.Request) {

	var a = make([]byte, 1073741824)
	_ = a
}

```
```
上面的代码是用来监控内存指标，超过咱们设置的规则，就会dump，并报警！
然后执行上面的代码，这样服务就被监控起来了，哈哈哈。

访问这个接口
http://127.0.0.1:10003/make1gb

你会发现在tmp/holmes目录下有个

```
[![ppDQs41.png](https://s1.ax1x.com/2023/03/25/ppDQs41.png)](https://imgse.com/i/ppDQs41)

```
咱们现在进入该文件所在目录，开始分析这个文件

go tool pprof mem..20230325130917.601.log

使用 traces 就能很快找到内存泄漏的代码是哪一个，如下图所示
```

[![ppD1bnS.png](https://s1.ax1x.com/2023/03/25/ppD1bnS.png)](https://imgse.com/i/ppD1bnS)
















